<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Коллекция Chain</title>

  <style>
    /* --- Базовая стилизация --- */
    :root {
      --glass: rgba(255,255,255,0.06);
      --accent: #c084fc;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #fff;
      text-align: center;
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .container {
      max-width: 1100px;
      margin: 28px auto;
      padding: 20px;
    }

    h1 {
      margin: 10px 0 18px;
      font-size: 2.1rem;
      letter-spacing: 1px;
      text-shadow: 0 0 12px var(--accent);
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    input#nick {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      width: 220px;
      font-size: 1rem;
      outline: none;
      background: rgba(255,255,255,0.03);
      color: #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.25) inset;
    }

    button {
      padding: 10px 18px;
      background: linear-gradient(45deg, #7f00ff, #e100ff);
      border: none;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s, opacity 0.2s;
    }

    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }

    .status-bar {
      display:flex;
      justify-content:center;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    .loader {
      border: 4px solid rgba(255,255,255,0.12);
      border-top: 4px solid #8a2be2;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .progress {
      font-size: 0.95rem;
      font-weight: 500;
      color: #f1f1f1;
      opacity: 0.95;
    }

    .tabs {
      margin: 20px 0 6px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      cursor: pointer;
      transition: 0.18s;
      user-select: none;
    }

    .tab.active {
      background: var(--accent);
      color: #111;
      box-shadow: 0 6px 18px rgba(192,132,252,0.18);
      font-weight: 700;
    }

    /* --- Сетка карточек --- */
    .cards {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      padding: 20px;
      min-height: 120px;
    }

    .card {
      width: 180px;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      transition: transform 0.35s ease, box-shadow 0.35s ease;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      cursor: pointer;
      transform-origin: center center;
      background: var(--glass);
      display:flex;
      flex-direction:column;
      align-items:stretch;
    }

    .card:hover { transform: translateY(-6px) scale(1.02); }

    .card img {
      width: 100%;
      height: 240px;
      object-fit: cover;
      display: block;
      background: linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.25));
    }

    .no-img {
      width: 100%;
      height: 240px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      opacity: 0.72;
      background: repeating-linear-gradient(
          45deg,
          rgba(255,255,255,0.03),
          rgba(255,255,255,0.03) 10px,
          rgba(0,0,0,0.12) 10px,
          rgba(0,0,0,0.12) 20px
      );
    }

    .card-content {
      padding: 10px;
      text-align: left;
      font-size: 0.9rem;
      line-height: 1.2;
    }

    .card-content h3 {
      margin: 0 0 6px;
      font-size: 1rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .card-content p {
      margin: 0;
      font-size: 0.82rem;
      opacity: 0.9;
      color: #eaeaea;
      display:block;
      max-height: 2.4em;
      overflow: hidden;
    }

    /* rarity colors */
    .common { border: 2px solid silver; }
    .uncommon { border: 2px solid #3cff00; }
    .rare { border: 2px solid #009dff; }
    .epic { border: 2px solid #c63cff; }
    .legendary { border: 2px solid #ff9c00; }

    .common .card-content { background: rgba(192,192,192,0.04); }
    .uncommon .card-content { background: rgba(60,255,0,0.03); }
    .rare .card-content { background: rgba(0,157,255,0.03); }
    .epic .card-content { background: rgba(198,60,255,0.03); }
    .legendary .card-content { background: rgba(255,156,0,0.03); }

    .card.expanded {
      transform: scale(1.9) !important;
      z-index: 2000;
      box-shadow: 0 20px 60px rgba(0,0,0,0.7);
    }

    @media (max-width: 600px) {
      .card { width: 86%; }
      .card.expanded { transform: scale(1.15) !important; }
    }

    .muted { opacity: 0.8; font-size: .95rem; }

  </style>
</head>

<body>
  <div class="container">
    <h1>Коллекция Chain</h1>

    <div class="controls" role="region" aria-label="Поиск пользователя">
      <input id="nick" placeholder="Введите ник Twitch" aria-label="Ник Twitch" />
      <button id="btn" type="button">Показать</button>
      <button id="clear" type="button" title="Очистить поле">Очистить</button>
    </div>

    <div class="status-bar" aria-live="polite">
      <div id="loader" style="display:none;" class="loader" aria-hidden="true"></div>
      <div id="progress" class="progress muted"></div>
    </div>

    <div class="tabs" id="tabs" style="display:none;">
      <div class="tab active" data-tab="owned" role="button" tabindex="0">Только мои</div>
      <div class="tab" data-tab="missing" role="button" tabindex="0">Отсутствуют</div>
      <div class="tab" data-tab="all" role="button" tabindex="0">Все</div>
    </div>

    <div id="cards" class="cards" aria-live="polite"></div>
  </div>

  <script>
    // === Настройки API ===
    const API = "https://script.google.com/macros/s/AKfycbxLKZBkRKb5GWESxw8-awH5ElHqBpGgCnLrwrvIMUCOCpBL_wq8dVXwoYCcMkfauX5Z/exec";

    // === Элементы DOM ===
    const btn = document.getElementById("btn");
    const clearBtn = document.getElementById("clear");
    const input = document.getElementById("nick");
    const cardsDiv = document.getElementById("cards");
    const progressDiv = document.getElementById("progress");
    const loader = document.getElementById("loader");
    const tabs = document.getElementById("tabs");

    let allCards = []; // всегда массив
    let currentMode = "owned";
    let isLoading = false;

    // === Утилиты ===
    function setLoading(on) {
      isLoading = !!on;
      loader.style.display = on ? "block" : "none";
      btn.disabled = on;
      input.disabled = on;
      clearBtn.disabled = on;
      if (!on) loader.setAttribute('aria-hidden', 'true');
      else loader.removeAttribute('aria-hidden');
    }

    function showMessage(text, muted = false) {
      progressDiv.textContent = text || "";
      progressDiv.classList.toggle("muted", muted);
    }

    function safeLower(str) {
      return (String(str || "")).toLowerCase();
    }

    // === Обработка ошибок загрузки изображений: подставляем плейсхолдер ===
    function onImgError(e) {
      const img = e.target;
      img.onerror = null;
      img.src = "https://via.placeholder.com/180x240?text=No+Image";
    }

    // === Нажатия табов ===
    function initTabs() {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
          currentMode = tab.dataset.tab || "owned";
          render(currentMode);
        });

        // клавиатурная поддержка
        tab.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); tab.click(); }
        });
      });
    }

    // === Рендер карточек ===
    function render(mode = "owned") {
      cardsDiv.innerHTML = "";

      if (!Array.isArray(allCards) || allCards.length === 0) {
        showMessage("Карточек не найдено для этого пользователя.", true);
        tabs.style.display = "none";
        return;
      }

      tabs.style.display = "flex";
      showMessage(buildProgressText(), false);

      const list = mode === "owned"
        ? allCards.filter(c => String(c.owned) === "1" || c.owned === true || c.owned === 1)
        : mode === "missing"
          ? allCards.filter(c => String(c.owned) === "0" || c.owned === false || c.owned === 0)
          : allCards;

      if (list.length === 0) {
        cardsDiv.innerHTML = `<div class="muted">Нет карточек в выбранной категории.</div>`;
        return;
      }

      // создание карточек
      list.forEach(c => {
        const rarityClass = safeLower(c.rarity || "common").replace(/\s+/g, "-");
        const div = document.createElement("div");
        div.className = `card ${rarityClass}`;

        // безопасные поля
        const name = c.name || "Без имени";
        const rarity = c.rarity || "unknown";
        const description = c.description ? String(c.description) : "";

        const hasImage = c.image && String(c.image).trim().length > 4;

        const mediaHtml = hasImage
          ? `<img loading="lazy" src="${escapeUrl(c.image)}" alt="${escapeHtml(name)}" onerror="(function(e){e.target.onerror=null;e.target.src='https://via.placeholder.com/180x240?text=No+Image'}) (event)">`
          : `<div class="no-img">Нет изображения</div>`;

        div.innerHTML = `
          ${mediaHtml}
          <div class="card-content">
            <h3 title="${escapeHtml(name)}">${escapeHtml(name)}</h3>
            <p>${escapeHtml(rarity)} ${description ? ' • ' + escapeHtml(truncate(description, 120)) : ''}</p>
          </div>
        `;

        // раскрытие карточки по клику
        div.addEventListener("click", () => {
          div.classList.toggle("expanded");
          // если расширяем, прокручиваем чуть выше для удобства мобильных
          if (div.classList.contains("expanded")) {
            setTimeout(() => div.scrollIntoView({behavior: "smooth", block: "center"}), 150);
          }
        });

        cardsDiv.appendChild(div);
      });
    }

    // === Вспомогательные функции безопасности/форматирования ===
    function escapeHtml(text) {
      return String(text)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function escapeUrl(url) {
      try {
        // простая проверка — если url начинается с http/https, возвращаем как есть, иначе используем placeholder
        const s = String(url).trim();
        if (s.startsWith("http://") || s.startsWith("https://")) return s;
        return "https://via.placeholder.com/180x240?text=No+Image";
      } catch (e) {
        return "https://via.placeholder.com/180x240?text=No+Image";
      }
    }

    function truncate(str, n) {
      const s = String(str || "");
      return s.length > n ? s.slice(0, n-1) + "…" : s;
    }

    function buildProgressText(data) {
      // если data не передали, используем last-known из allCards (если есть)
      // лучше, если API вернёт прогресс отдельно. Здесь строим текст по возвращаемым полям (с запасом)
      try {
        // если API возвращал глобально progress fields, мы их сохранили в window.lastApiInfo
        const info = window.lastApiInfo || {};
        const owned = typeof info.ownedUniqueCards !== 'undefined' ? info.ownedUniqueCards : (allCards.filter(c => String(c.owned) === "1").length);
        const total = typeof info.totalUniqueCards !== 'undefined' ? info.totalUniqueCards : allCards.length;
        const percent = typeof info.progressPercent !== 'undefined' ? info.progressPercent : Math.round((owned / Math.max(total,1)) * 100);

        return `Ваши: ${owned} / ${total} (${percent}%)`;
      } catch (e) {
        return "";
      }
    }

    // === Загрузка данных ===
    async function load() {
      const nick = input.value.trim();
      if (!nick) { alert("Введите ник!"); input.focus(); return; }

      setLoading(true);
      cardsDiv.innerHTML = "";
      showMessage("Загружаем...", true);
      tabs.style.display = "none";
      allCards = [];

      try {
        const url = `${API}?player=${encodeURIComponent(nick)}`;
        const res = await fetch(url, { method: "GET", cache: "no-store" });

        if (!res.ok) {
          // пытаемся прочитать текст ошибки
          let txt = await res.text().catch(()=>"");
          throw new Error(`Сервер вернул ${res.status} ${res.statusText}. ${txt ? 'Ответ: ' + txt : ''}`);
        }

        const data = await res.json().catch(() => { throw new Error("Не удалось разобрать JSON от сервера."); });

        // API может вернуть структуру по-разному — делаем безопасные присвоения
        if (data.error) {
          throw new Error(data.message || "Сервер вернул ошибку.");
        }

        // ожидаем, что cards — массив
        if (!Array.isArray(data.cards)) {
          // возможно API вернул объект внутри data.result или data.data
          if (Array.isArray(data.result)) allCards = data.result;
          else if (Array.isArray(data.data)) allCards = data.data;
          else allCards = [];
        } else {
          allCards = data.cards;
        }

        // сохраняем прогресс-инфо для отображения
        window.lastApiInfo = {
          ownedUniqueCards: data.ownedUniqueCards ?? data.ownedCount ?? undefined,
          totalUniqueCards: data.totalUniqueCards ?? data.totalCount ?? allCards.length,
          progressPercent: data.progressPercent ?? undefined
        };

        // приведение типов: иногда owned приходит как "0"/"1"
        allCards = allCards.map(item => {
          // нормализация полей
          return {
            name: item.name ?? item.cardName ?? "",
            rarity: item.rarity ?? item.tier ?? "common",
            description: item.description ?? item.desc ?? "",
            image: item.image ?? item.img ?? "",
            owned: (item.owned === true || item.owned === 1 || String(item.owned) === "1") ? 1 : 0,
            // копируем оригинал на случай дальнейшего использования
            __raw: item
          };
        });

        if (allCards.length === 0) {
          showMessage("Карточек не найдено для указанного ника.", true);
          tabs.style.display = "none";
          setLoading(false);
          return;
        }

        // показываем прогресс и рендерим
        showMessage(buildProgressText(), false);
        tabs.style.display = "flex";
        // рендерим выбранный режим (по умолчанию owned)
        render(currentMode);
      } catch (err) {
        console.error(err);
        showMessage("Ошибка: " + (err && err.message ? err.message : "Неизвестная ошибка"), true);
      } finally {
        setLoading(false);
      }
    }

    // === Инициализация событий ===
    btn.addEventListener("click", load);
    clearBtn.addEventListener("click", () => { input.value = ""; input.focus(); });
    input.addEventListener("keydown", (e) => { if (e.key === "Enter") load(); });

    initTabs();

    // По-умолчанию подсказка
    showMessage("Введите ник и нажмите «Показать»", true);

  </script>
</body>
</html>
