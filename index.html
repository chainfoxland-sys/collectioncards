<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Коллекция Chain</title>

  <style>
    :root { --glass: rgba(255,255,255,0.06); --accent: #c084fc; }
    body{
      margin:0;padding:0;
      font-family:"Poppins",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:#fff;text-align:center;
      background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);
      background-size:400% 400%;animation:gradientShift 15s ease infinite;min-height:100vh;
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

    .container{max-width:1100px;margin:28px auto;padding:20px}
    h1{margin:10px 0 18px;font-size:2.3rem;text-shadow:0 0 12px var(--accent)}

    .controls{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    input#nick{padding:10px 15px;border-radius:10px;border:none;width:240px;background:rgba(255,255,255,0.08);color:#fff;outline:none}
    button{padding:10px 18px;border:none;border-radius:10px;background:linear-gradient(45deg,#7f00ff,#e100ff);color:#fff;font-weight:600;cursor:pointer;transition:.25s}
    button:hover{transform:translateY(-3px)}

    .status-bar{margin:10px 0;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
    .loader{border:4px solid rgba(255,255,255,0.15);border-top:4px solid var(--accent);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;display:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{font-size:0.95rem;opacity:.95}

    .tabs{margin-top:18px;display:none;justify-content:center;gap:12px;flex-wrap:wrap}
    .tab{padding:8px 16px;border-radius:30px;background:rgba(255,255,255,0.1);cursor:pointer;transition:.25s}
    .tab.active{background:var(--accent);color:#111;box-shadow:0 0 15px rgba(192,132,252,0.45);font-weight:700}

    .cards{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;padding:20px;min-height:140px}
    .card{width:180px;border-radius:14px;background:var(--glass);overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.45);transition:.35s;cursor:pointer;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-6px) scale(1.02)}
    .card img{width:100%;height:240px;object-fit:cover;background:rgba(0,0,0,0.25)}
    .no-img{width:100%;height:240px;display:flex;align-items:center;justify-content:center;background:repeating-linear-gradient(45deg, rgba(255,255,255,0.04), rgba(255,255,255,0.04) 10px, rgba(0,0,0,0.2) 10px, rgba(0,0,0,0.2) 20px);opacity:.75;font-size:0.9rem}
    .card-content{padding:10px;text-align:left;font-size:.9rem;flex:0 0 auto}
    .card-content h3{margin:0 0 6px;font-size:1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .card-content p{margin:0;font-size:.85rem;color:#eaeaea}
    .muted{opacity:.8}

    /* rarity borders */
    .common{border:2px solid silver}
    .uncommon{border:2px solid #3cff00}
    .rare{border:2px solid #009dff}
    .epic{border:2px solid #c63cff}
    .legendary{border:2px solid #ff9c00}

    /* overlay full view */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(3px);display:none;z-index:900;
    }
    .overlay.show{display:block}
    .expanded-modal{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:1000;
      max-width:92vw;max-height:92vh;border-radius:12px;overflow:auto;background:rgba(255,255,255,0.02);box-shadow:0 20px 60px rgba(0,0,0,0.8)
    }
    .expanded-modal img{max-width:100%;max-height:70vh;display:block;margin:0 auto;border-radius:6px}

    @media(max-width:600px){ .card{width:86%} .expanded-modal{width:92vw} }
  </style>
</head>
<body>
  <div class="container">
    <h1>Коллекция Chain</h1>

    <div class="controls">
      <input id="nick" placeholder="Введите ник Twitch" />
      <button id="btn">Показать</button>
    </div>

    <div class="status-bar">
      <div id="loader" class="loader" aria-hidden="true"></div>
      <div id="progress" class="progress muted">Введите ник и нажмите «Показать»</div>
    </div>

    <div id="tabs" class="tabs" aria-hidden="true">
      <div class="tab active" data-tab="owned">Только мои</div>
      <div class="tab" data-tab="missing">Отсутствуют</div>
      <div class="tab" data-tab="all">Все</div>
    </div>

    <div id="cards" class="cards" role="list"></div>
  </div>

  <!-- overlay container for expanded view -->
  <div id="overlay" class="overlay" aria-hidden="true"></div>

<script>
/* Final unified JS:
 - normalizes API responses
 - renders tabs owned/missing/all
 - hides images for missing cards (in missing & for missing in all)
 - fallback for image errors
 - progress & loader handling
*/

const API = "https://script.google.com/macros/s/AKfycbxLKZBkRKb5GWESxw8-awH5ElHqBpGgCnLrwrvIMUCOCpBL_wq8dVXwoYCcMkfauX5Z/exec";

const btn = document.getElementById('btn');
const input = document.getElementById('nick');
const cardsDiv = document.getElementById('cards');
const progressDiv = document.getElementById('progress');
const loader = document.getElementById('loader');
const tabs = document.getElementById('tabs');
const overlay = document.getElementById('overlay');

let allCards = [];
let currentMode = 'owned';

function setLoading(on){
  loader.style.display = on ? 'block' : 'none';
  btn.disabled = on;
  // do NOT permanently disable input (previous bug)
  input.disabled = false;
}

function showMessage(text, muted = true){
  progressDiv.textContent = text;
  progressDiv.classList.toggle('muted', muted);
}

function safeLower(s){ return String(s||'').toLowerCase(); }
function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'); }
function validImageUrl(url){
  try{
    if(!url) return false;
    const u = String(url).trim();
    return u.startsWith('http://') || u.startsWith('https://');
  }catch(e){ return false; }
}
function imgOnError(e){ e.target.onerror = null; e.target.src = 'https://via.placeholder.com/320x240?text=No+Image'; }

function initTabs(){
  tabs.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      currentMode = tab.dataset.tab || 'owned';
      render();
    });
  });
}

function buildProgressText(){
  const owned = allCards.filter(c => c.owned === 1).length;
  const total = allCards.length;
  const percent = total ? Math.round((owned/total)*100) : 0;
  return `Ваши: ${owned} / ${total} (${percent}%)`;
}

function clearCards(){ cardsDiv.innerHTML = ''; }

function render(){
  clearCards();
  if(!allCards || !allCards.length){
    showMessage('Карточек не найдено для этого пользователя.', true);
    tabs.style.display = 'none';
    return;
  }

  tabs.style.display = 'flex';
  showMessage(buildProgressText(), false);

  let list;
  if(currentMode === 'owned') list = allCards.filter(c => c.owned === 1);
  else if(currentMode === 'missing') list = allCards.filter(c => c.owned === 0);
  else list = allCards;

  if(list.length === 0){
    cardsDiv.innerHTML = `<div class="muted">Нет карточек в выбранной категории.</div>`;
    return;
  }

  list.forEach(card => {
    const rarityClass = safeLower(card.rarity || 'common').replace(/\s+/g,'-');
    const div = document.createElement('div');
    div.className = `card ${rarityClass}`;

    // Determine whether to show image:
    // - missing tab: never show images
    // - all tab: show image only if card.owned === 1
    // - owned tab: show image (if exists)
    const hasImageLink = validImageUrl(card.image);
    let showImage = false;
    if(currentMode === 'missing'){
      showImage = false;
    } else if(currentMode === 'all'){
      showImage = (card.owned === 1) && hasImageLink;
    } else { // owned
      showImage = (card.owned === 1) && hasImageLink;
    }

    const mediaHtml = showImage
      ? `<img loading="lazy" src="${escapeHtml(card.image)}" alt="${escapeHtml(card.name)}" onerror="this.onerror=null;this.src='https://via.placeholder.com/320x240?text=No+Image'">`
      : `<div class="no-img">Нет изображения</div>`;

    div.innerHTML = `
      ${mediaHtml}
      <div class="card-content">
        <h3 title="${escapeHtml(card.name)}">${escapeHtml(card.name)}</h3>
        <p>${escapeHtml(card.rarity || '')}${card.description ? ' • ' + escapeHtml(card.description) : ''}</p>
      </div>
    `;

    // click: show modal expanded view (only with image if available and owned)
    div.addEventListener('click', () => {
      // if there's an image shown, open expanded modal with bigger image and info
      if(showImage){
        openExpanded(card);
      } else {
        // no image — toggle small expand (scale) locally for UX
        div.classList.toggle('expanded');
        // remove expanded after second click if desired
      }
    });

    cardsDiv.appendChild(div);

    // small staggered reveal
    setTimeout(()=> div.classList.add('show'), 40);
  });
}

function openExpanded(card){
  // build modal content
  overlay.innerHTML = '';
  const modal = document.createElement('div');
  modal.className = 'expanded-modal';
  const img = document.createElement('img');
  img.src = validImageUrl(card.image) ? card.image : 'https://via.placeholder.com/640x480?text=No+Image';
  img.alt = card.name || '';
  img.onerror = imgOnError;
  const info = document.createElement('div');
  info.style.padding = '12px';
  info.innerHTML = `<h3 style="margin:0 0 8px">${escapeHtml(card.name)}</h3>
                    <p style="margin:0 0 6px;font-weight:600">${escapeHtml(card.rarity || '')}</p>
                    <p style="margin:0">${escapeHtml(card.description || '')}</p>`;
  modal.appendChild(img);
  modal.appendChild(info);
  overlay.appendChild(modal);
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');

  // click overlay to close
  overlay.onclick = (e) => {
    if(e.target === overlay){
      closeExpanded();
    }
  };
  // ESC to close
  document.addEventListener('keydown', escClose);
}

function closeExpanded(){
  overlay.classList.remove('show');
  overlay.innerHTML = '';
  overlay.setAttribute('aria-hidden','true');
  document.removeEventListener('keydown', escClose);
}

function escClose(e){ if(e.key === 'Escape') closeExpanded(); }

async function load(){
  const nick = input.value.trim();
  if(!nick){ alert('Введите ник!'); input.focus(); return; }

  setLoading(true);
  clearCards();
  showMessage('Загружаем...', true);
  tabs.style.display = 'none';
  allCards = [];

  try{
    const url = `${API}?player=${encodeURIComponent(nick)}`;
    const res = await fetch(url, { cache: 'no-store' });
    if(!res.ok){
      const txt = await res.text().catch(()=> '');
      throw new Error(`Сервер вернул ${res.status} ${res.statusText}. ${txt}`);
    }
    const data = await res.json().catch(()=> { throw new Error('Не удалось разобрать JSON от сервера.'); });

    if(data.error){
      throw new Error(data.message || 'Ошибка от API');
    }

    // Normalize cards: API might return data.cards or data.result or data.data
    let rawCards = [];
    if(Array.isArray(data.cards)) rawCards = data.cards;
    else if(Array.isArray(data.result)) rawCards = data.result;
    else if(Array.isArray(data.data)) rawCards = data.data;
    else if(Array.isArray(data)) rawCards = data;
    else rawCards = [];

    // If the other endpoint returns objects with duplicates, keep them all but mark owned appropriately.
    // Normalize each card object
    allCards = rawCards.map(item => {
      return {
        name: item.name ?? item.cardName ?? '',
        rarity: item.rarity ?? item.tier ?? '',
        description: item.description ?? item.desc ?? '',
        image: item.image ?? item.img ?? '',
        // owned detection: accept boolean, number, or string '1'/'0'
        owned: (item.owned === true || item.owned === 1 || String(item.owned) === '1') ? 1 : 0,
        __raw: item
      };
    });

    // If API provided progress info, store it (optional)
    window.lastApiInfo = {
      ownedUniqueCards: data.ownedUniqueCards ?? data.ownedCount ?? undefined,
      totalUniqueCards: data.totalUniqueCards ?? data.totalCount ?? undefined,
      progressPercent: data.progressPercent ?? undefined
    };

    if(!allCards.length){
      showMessage('У этого игрока пока нет карт.', true);
      tabs.style.display = 'none';
      setLoading(false);
      return;
    }

    // Update progress text & render
    showMessage(buildProgressText(), false);
    tabs.style.display = 'flex';
    initTabs(); // ensure tabs initialized (idempotent)
    render();
  }catch(err){
    console.error(err);
    showMessage('Ошибка: ' + (err && err.message ? err.message : 'Неизвестная ошибка'), true);
  }finally{
    setLoading(false);
  }
}

// events
btn.addEventListener('click', load);
input.addEventListener('keydown', (e) => { if(e.key === 'Enter') load(); });

// init
showMessage('Введите ник и нажмите «Показать»', true);
initTabs();

</script>
</body>
</html>
