<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Коллекция Chain — Готово</title>
<style>
  :root{
    --bg1:#0f0c29; --bg2:#302b63; --bg3:#24243e;
  }
  html,body{height:100%}
  body{
    margin:0;font-family:"Poppins",sans-serif;color:#fff;text-align:center;
    background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
    background-size:400% 400%;animation:gradientShift 15s ease infinite;min-height:100vh;
  }
  @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  h1{margin:18px 0;font-size:1.9rem;text-shadow:0 0 10px #b993ff}
  .input-container{display:flex;justify-content:center;gap:12px;flex-wrap:wrap;margin-bottom:12px}
  input{padding:10px 12px;border-radius:10px;border:none;width:220px;font-size:1rem;outline:none}
  button{padding:10px 16px;border-radius:10px;border:none;background:linear-gradient(45deg,#7f00ff,#e100ff);color:#fff;font-weight:600;cursor:pointer}
  .small{font-size:0.9rem;color:#ddd;margin-top:6px}
  .loader{margin:18px auto;display:none}.loading-text{font-style:italic;color:#ddd}
  .progress{margin:12px 10px;font-weight:600;color:#e6e6e6}
  .controls{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:6px}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px;padding:18px;max-width:1200px;margin:0 auto 60px}
  .card{background:rgba(255,255,255,0.04);border-radius:12px;overflow:hidden;box-shadow:0 8px 18px rgba(0,0,0,0.4);transition:transform .3s,box-shadow .3s,opacity .3s;cursor:pointer;transform-origin:center center;opacity:0;transform:translateY(8px) scale(.98);display:flex;flex-direction:column;align-items:stretch}
  .card.show{opacity:1;transform:translateY(0) scale(1)}
  .card img{width:100%;height:160px;object-fit:cover;background:linear-gradient(45deg, rgba(0,0,0,.2), rgba(255,255,255,0.02))}
  .card-info{padding:10px;text-align:left;color:#fff;flex:1;display:flex;flex-direction:column;gap:6px}
  .card-info h3{margin:0;font-size:1rem}
  .card-info p{margin:0;font-size:.9rem;color:#ddd}
  .common{border:2px solid rgba(255,255,255,0.06)}
  .uncommon{border:2px solid rgba(124,255,0,0.18)}
  .rare{border:2px solid rgba(0,157,255,0.18)}
  .epic{border:2px solid rgba(198,60,255,0.18)}
  .legendary{border:2px solid rgba(255,156,0,0.18)}
  .card.expanded{position:fixed;top:50%;left:50%;width:90vw;max-width:760px;max-height:90vh;transform:translate(-50%,-50%);z-index:1000;border-radius:14px;overflow:auto;box-shadow:0 30px 80px rgba(0,0,0,.75);background:linear-gradient(180deg,rgba(12,10,20,.98),rgba(24,20,40,.98))}
  .card.expanded img{height:auto;max-height:60vh;object-fit:contain}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(3px);display:none;z-index:900}
  .overlay.show{display:block}
  @media(max-width:768px){.cards{grid-template-columns:repeat(2,1fr);gap:10px;padding:10px}.card img{height:120px}.card.expanded{width:96vw;max-width:96vw;border-radius:10px}}
  .not-owned .card-info{opacity:.85}.not-owned img{filter:grayscale(70%) contrast(.9) brightness(.9)}
  .duplicates{font-size:.85rem;color:#ffdca8;font-weight:600}
  .filters{display:flex;gap:8px;justify-content:center;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.04);cursor:pointer;border:1px solid rgba(255,255,255,0.03)}
  .chip.active{background:linear-gradient(45deg,#7f00ff,#e100ff);box-shadow:0 6px 18px rgba(127,0,255,0.18)}
</style>
</head>
<body>
  <h1>Коллекция Chain</h1>

  <div class="input-container">
    <input id="nick" placeholder="Введите ник на Twitch" />
    <button id="btn">Показать коллекцию</button>
  </div>

  <div class="controls">
    <div class="filters" id="filters" style="display:none;">
      <div class="chip active" data-filter="all" id="f_all">Все</div>
      <div class="chip" data-filter="owned" id="f_owned">Только мои</div>
      <div class="chip" data-filter="notowned" id="f_notowned">Отсутствуют</div>
      <div class="chip" data-filter="legendary" id="f_legend">Легендарные</div>
    </div>
  </div>

  <div id="loader" class="loader"><div class="loading-text">Загружаю коллекцию...</div></div>
  <div class="progress" id="progress"></div>
  <div class="cards" id="cards"></div>
  <div id="overlay" class="overlay"></div>

<script>
/* ========== ПОДСТАВЬ СЮДА СВОЙ WEB APP URL (УЖЕ ВСТАВЛЕН) ========== */
const API_BASE = "https://script.google.com/macros/s/AKfycbyrI-0pcHW6SJLkvNbzqANhJ90ttPfx-1E8GYlqBDnu76Jf0ZOVblJVrfPcQpkvzoh87A/exec";
/* ================================================================ */

const btn = document.getElementById("btn");
const input = document.getElementById("nick");
const cardsDiv = document.getElementById("cards");
const progressDiv = document.getElementById("progress");
const loader = document.getElementById("loader");
const overlay = document.getElementById("overlay");
const filtersBar = document.getElementById("filters");

btn.addEventListener("click", loadCollection);
input.addEventListener("keydown", (e) => { if (e.key === "Enter") loadCollection(); });

// filters
document.addEventListener('click', (ev) => {
  const chip = ev.target.closest('.chip');
  if (!chip) return;
  document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  applyFilter(chip.dataset.filter);
});

let lastAll = [];
let lastOwned = [];
let lastNotOwned = [];

function rarityToClass(r) {
  if (!r) return "common";
  const s = String(r).trim().toLowerCase();
  if (s.includes("legend")) return "legendary";
  if (s.includes("epic")) return "epic";
  if (s.includes("rare")) return "rare";
  if (s.includes("uncommon")) return "uncommon";
  return "common";
}

async function loadCollection() {
  const nick = input.value.trim();
  if (!nick) { alert("Введите ник!"); return; }

  // reset UI
  cardsDiv.innerHTML = "";
  progressDiv.textContent = "";
  loader.style.display = "block";
  filtersBar.style.display = "none";

  try {
    const res = await fetch(`${API_BASE}?player=${encodeURIComponent(nick)}`);
    loader.style.display = "none";
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();

    if (data.error && data.message === "No player specified") {
      progressDiv.textContent = "Ошибка API: Не указан игрок.";
      return;
    }

    // if player not found, we still get allCards
    const allCards = data.allCards || [];
    const playerCards = data.playerCards || data.ownedCards || [];
    const counts = data.counts || {};

    // build maps
    const playerMap = {};
    playerCards.forEach(c => playerMap[String(c.id)] = c);

    const owned = [];
    const notOwned = [];

    allCards.forEach(card => {
      const id = String(card.id);
      if (playerMap[id]) {
        const pc = playerMap[id];
        if (!pc.count) pc.count = counts[id] || 1;
        owned.push(pc);
      } else {
        notOwned.push({...card, owned:false});
      }
    });

    // include any playerCards not present in allCards (defensive)
    playerCards.forEach(pc => {
      if (!allCards.find(a => String(a.id) === String(pc.id))) owned.push(pc);
    });

    lastAll = allCards;
    lastOwned = owned;
    lastNotOwned = notOwned;

    // show filter controls when there is data
    if (allCards.length > 0) {
      filtersBar.style.display = "flex";
      document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
      document.getElementById('f_all').classList.add('active');
    }

    const ownedUnique = owned.length;
    const totalUnique = allCards.length || ownedUnique;
    const percent = totalUnique > 0 ? Math.round((ownedUnique / totalUnique) * 100) : 0;
    progressDiv.textContent = `Уникальных: ${ownedUnique}/${totalUnique} (${percent}%)`;

    renderCards(owned, notOwned, 'all');

  } catch (err) {
    loader.style.display = "none";
    console.error(err);
    progressDiv.textContent = "Ошибка: " + err.message;
  }
}

function renderCards(owned, notOwned, mode) {
  cardsDiv.innerHTML = "";
  let items = [];
  if (mode === 'owned') items = owned.slice();
  else if (mode === 'notowned') items = notOwned.slice();
  else items = owned.concat(notOwned);

  let idx = 0;
  items.forEach(c => {
    appendCard(c, c.owned === true, idx++);
  });
}

function appendCard(c, ownedFlag, orderIndex) {
  const rarityClass = rarityToClass(c.rarity);
  const wrap = document.createElement("div");
  wrap.className = "card " + rarityClass + (ownedFlag ? "" : " not-owned");
  const imgSrc = c.image && c.image.length ? c.image : placeholderSVG();
  wrap.innerHTML = `
    <img src="${imgSrc}" alt="${escapeHtml(c.name||c.id)}" loading="lazy">
    <div class="card-info">
      <h3>${escapeHtml(c.name || ("Карта #" + c.id))}</h3>
      <p class="rarity">${escapeHtml(c.rarity || "")}${ownedFlag && c.count && c.count > 1 ? ` — <span class="duplicates">Дублей: ${c.count - 1}</span>` : ""}</p>
      <p style="font-size:0.85rem;color:#cfcfcf;">${escapeHtml(c.description || "")}</p>
    </div>
  `;
  // staggered show
  setTimeout(() => wrap.classList.add("show"), orderIndex * 30);

  // click handling: expand to center
  wrap.addEventListener("click", () => {
    const already = wrap.classList.contains("expanded");
    closeAllExpanded();
    if (!already) {
      wrap.classList.add("expanded");
      overlay.classList.add("show");
      // prevent background scroll on mobile when expanded
      document.body.style.overflow = "hidden";
      // focus trap: scroll to top of expanded card
      setTimeout(() => { wrap.scrollIntoView({behavior:"smooth", block:"center"}); }, 100);
    } else {
      document.body.style.overflow = "";
    }
  });

  cardsDiv.appendChild(wrap);
}

function closeAllExpanded() {
  document.querySelectorAll('.card.expanded').forEach(el => el.classList.remove('expanded'));
  overlay.classList.remove('show');
  document.body.style.overflow = "";
}

overlay.addEventListener("click", closeAllExpanded);
window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeAllExpanded(); });

// filter apply
function applyFilter(filter) {
  if (filter === 'all') renderCards(lastOwned, lastNotOwned, 'all');
  else if (filter === 'owned') renderCards(lastOwned, lastNotOwned, 'owned');
  else if (filter === 'notowned') renderCards(lastOwned, lastNotOwned, 'notowned');
  else if (filter === 'legendary') {
    const legendOwned = lastOwned.filter(c => rarityToClass(c.rarity) === 'legendary');
    const legendNot = lastNotOwned.filter(c => rarityToClass(c.rarity) === 'legendary');
    renderCards(legendOwned, legendNot, 'all');
  }
}

// helpers
function escapeHtml(unsafe) {
  if (unsafe === null || unsafe === undefined) return "";
  return String(unsafe).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
}

function placeholderSVG(){
  return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='400'%3E%3Crect width='600' height='400' fill='%2324243e'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23aaa' font-size='20'%3ENo+image%3C/text%3E%3C/svg%3E";
}
</script>
</body>
</html>
